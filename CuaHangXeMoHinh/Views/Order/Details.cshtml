@model CuaHangXeMoHinh.Models.Order
@using CuaHangXeMoHinh.Extensions
@{
    ViewData["Title"] = $"Order Details #{Model.Id:D6}";
    Layout = "_Layout";
}

<div class="container mx-auto px-4 py-24 min-h-screen">
    @Html.AntiForgeryToken()
    
    <!-- Breadcrumb & Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-12 gap-6 print:hidden">
        <div>
            <a asp-action="History" class="text-zinc-500 hover:text-white transition-colors flex items-center gap-2 mb-4 text-sm font-bold uppercase tracking-wider">
                <i class="bi bi-arrow-left"></i> Back to History
            </a>
            <h1 class="text-3xl md:text-5xl font-display font-bold text-white uppercase tracking-tighter mb-2">
                ORDER <span class="text-stroke-primary text-transparent">#@Model.Id.ToString("D6")</span>
            </h1>
            <p class="text-zinc-500">
                Placed on <span class="text-white">@Model.CreatedAt.ToString("dd/MM/yyyy")</span> at <span class="text-white">@Model.CreatedAt.ToString("HH:mm")</span>
            </p>
        </div>
        
        <div class="flex items-center gap-4">
            @{
                 var statusClass = Model.Status.ToString() switch {
                    "Pending" => "bg-yellow-500/10 text-yellow-500 border-yellow-500/20",
                    "Completed" => "bg-green-500/10 text-green-500 border-green-500/20",
                    "Cancelled" => "bg-red-500/10 text-red-500 border-red-500/20",
                    "Shipping" => "bg-blue-500/10 text-blue-500 border-blue-500/20",
                    _ => "bg-zinc-700/50 text-zinc-300 border-zinc-600"
                };
            }
             <div class="px-4 py-2 text-sm font-bold uppercase tracking-wider rounded border @statusClass">
                @Model.Status.GetDisplayName()
            </div>

            @if (Model.Status == OrderStatus.Pending)
            {
                <button type="button"
                        class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20 transition-colors font-bold uppercase tracking-wider text-sm cancel-order-btn"
                        data-order-id="@Model.Id">
                     CANCEL ORDER
                </button>
            }
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left: Products & Timeline -->
        <div class="lg:col-span-2 space-y-8">
            
            <!-- Products Card -->
            <div class="bg-zinc-900/50 border border-white/10 backdrop-blur-md p-6 md:p-8">
               <h3 class="text-xl font-display font-bold text-white mb-6 flex items-center gap-3 uppercase">
                   <i class="bi bi-box-seam text-primary"></i> Order Items
               </h3>
               
               <div class="space-y-6">
                   @foreach (var item in Model.Items)
                   {
                       <div class="flex items-start gap-4 pb-6 border-b border-white/5 last:border-0 last:pb-0">
                           <a href="@Url.Action("Detail", "Products", new { id = item.ProductId })" class="block w-20 h-20 md:w-24 md:h-24 bg-zinc-800 border border-white/10 shrink-0 overflow-hidden group">
                                <img src="@(item.Product?.Images?.FirstOrDefault()?.Url ?? "https://placehold.co/80")"
                                     alt="@item.Product?.Name"
                                     class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500">
                           </a>
                           
                           <div class="flex-1 min-w-0">
                               <a href="@Url.Action("Detail", "Products", new { id = item.ProductId })" class="text-white font-bold hover:text-primary transition-colors text-lg truncate block">
                                   @item.Product?.Name
                               </a>
                               <p class="text-zinc-500 text-sm mb-2">ID: @item.ProductId</p>
                               <div class="flex justify-between items-center text-sm md:text-base">
                                   <div class="text-zinc-400">
                                       @item.UnitPrice.ToString("N0") đ <span class="mx-2">x</span> @item.Quantity
                                   </div>
                                   <div class="text-white font-mono font-bold">
                                       @((item.UnitPrice * item.Quantity).ToString("N0")) đ
                                   </div>
                               </div>
                           </div>
                       </div>
                   }
               </div>
            </div>

            <!-- Timeline Status -->
            <div class="bg-zinc-900/50 border border-white/10 backdrop-blur-md p-6 md:p-8 print:hidden">
                <h3 class="text-xl font-display font-bold text-white mb-8 flex items-center gap-3 uppercase">
                   <i class="bi bi-clock-history text-primary"></i> Order Status
                </h3>
                
                <div class="relative pl-4 md:pl-8 border-l border-zinc-700 space-y-8">
                    @* Helper function or manual list to generate timeline steps based on Status *@
                    @{
                         var timeline = new List<(OrderStatus Status, string Title, string Desc)>
                         {
                             (OrderStatus.Pending, "Order Placed", "Your order has been received"),
                             (OrderStatus.Processing, "Processing", "We are packing your items"),
                             (OrderStatus.Shipped, "Shipped", "Your order is on the way"),
                             (OrderStatus.Delivered, "Delivered", "Package has been delivered")
                         };
                         
                         // Special handling for Cancelled/Return
                         bool isCancelled = Model.Status == OrderStatus.Cancelled;
                         bool isReturnRequested = Model.Status == OrderStatus.ReturnRequested;
                         bool isReturned = Model.Status == OrderStatus.Returned;
                         bool isReturnDenied = Model.Status == OrderStatus.ReturnDenied;
                    }

                    @if (isCancelled)
                    {
                         <div class="relative pl-8">
                            <span class="absolute -left-[41px] top-0 w-5 h-5 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)] border-2 border-black"></span>
                            <h4 class="text-red-500 font-bold text-lg uppercase">Cancelled</h4>
                            <p class="text-zinc-400 text-sm">This order has been cancelled.</p>
                        </div>
                    }
                    else if (isReturnRequested || isReturned || isReturnDenied)
                    {
                         // Show normal timeline up to Delivered (assumed) then show Return status
                         <div class="relative pl-8">
                            @{
                                var returnColor = isReturned ? "bg-green-500 text-green-500" : (isReturnDenied ? "bg-red-500 text-red-500" : "bg-yellow-500 text-yellow-500");
                            }
                            <span class="absolute -left-[41px] top-0 w-5 h-5 rounded-full @returnColor.Split(' ')[0] shadow-[0_0_10px_currentColor] border-2 border-black"></span>
                            <h4 class="@returnColor.Split(' ')[1] font-bold text-lg uppercase">
                                @(isReturned ? "Returned" : (isReturnDenied ? "Return Denied" : "Return Requested"))
                            </h4>
                            <p class="text-zinc-400 text-sm">
                                @(isReturned ? "Refund processed." : (isReturnDenied ? "Return request was denied." : "Waiting for approval."))
                            </p>
                        </div>
                    }
                    else
                    {
                        foreach (var step in timeline)
                        {
                            bool isCompleted = Model.Status >= step.Status;
                            bool isCurrent = Model.Status == step.Status;
                            
                            var dotColor = isCompleted ? "bg-primary shadow-[0_0_10px_var(--color-primary)]" : "bg-zinc-800 border border-zinc-600";
                            var textColor = isCompleted ? "text-white" : "text-zinc-500";
                            
                            <div class="relative pl-8">
                                <span class="absolute -left-[41px] md:-left-[41px] top-1 w-5 h-5 rounded-full @dotColor transition-all z-10"></span>
                                <h4 class="@textColor font-bold text-lg uppercase transition-colors">@step.Title</h4>
                                <p class="text-zinc-500 text-sm">@step.Desc</p>
                                @if(isCurrent) {
                                     <p class="text-primary text-xs mt-1 font-mono">@Model.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")</p>
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Right: Summary & Info -->
        <div class="space-y-8">
            <!-- Payment Summary -->
            <div class="bg-zinc-900 border border-white/10 p-6 md:p-8">
                 <h3 class="text-xl font-display font-bold text-white mb-6 uppercase">Summary</h3>
                 
                 <div class="space-y-4 text-sm">
                     <div class="flex justify-between text-zinc-400">
                         <span>Subtotal</span>
                         <span class="text-white font-mono">@Model.Items.Sum(i => i.UnitPrice * i.Quantity).ToString("N0") đ</span>
                     </div>
                     <div class="flex justify-between text-zinc-400">
                         <span>Shipping</span>
                         <span class="text-white font-mono">@Model.ShippingFee.ToString("N0") đ</span>
                     </div>
                     <div class="flex justify-between text-zinc-400">
                         <span>Discount</span>
                         <span class="text-red-500 font-mono">-@Model.Discount.ToString("N0") đ</span>
                     </div>
                     
                     <div class="h-px bg-white/10 my-4"></div>
                     
                     <div class="flex justify-between items-center">
                         <span class="text-white font-bold uppercase">Total</span>
                         <span class="text-2xl text-primary font-display font-bold">@Model.TotalAmount.ToString("N0") đ</span>
                     </div>
                 </div>
                 
                 <div class="mt-6 bg-white/5 p-4 rounded border border-white/5">
                     <div class="flex items-center gap-3 text-sm text-zinc-400">
                         <i class="bi bi-wallet2"></i>
                         <span>Payment Method: <span class="text-white font-bold">COD</span></span>
                     </div>
                 </div>
            </div>

            <!-- Shipping Info -->
            <div class="bg-zinc-900 border border-white/10 p-6 md:p-8">
                 <h3 class="text-xl font-display font-bold text-white mb-6 uppercase">Delivery to</h3>
                 
                 @if (Model.ShippingAddress != null)
                 {
                     <div class="space-y-4">
                         <div class="flex items-start gap-4">
                             <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center text-primary shrink-0">
                                 <i class="bi bi-person"></i>
                             </div>
                             <div>
                                 <p class="text-white font-bold">@Model.User?.FullName</p>
                                 <p class="text-zinc-500 text-sm">Customer</p>
                             </div>
                         </div>
                         
                         <div class="flex items-start gap-4">
                             <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center text-primary shrink-0">
                                 <i class="bi bi-telephone"></i>
                             </div>
                             <div>
                                 <p class="text-white">@Model.User?.PhoneNumber</p>
                                 <p class="text-zinc-500 text-sm">Phone</p>
                             </div>
                         </div>
                         
                         <div class="flex items-start gap-4">
                             <div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center text-primary shrink-0">
                                 <i class="bi bi-geo-alt"></i>
                             </div>
                             <div>
                                 <p class="text-zinc-300 text-sm leading-relaxed">
                                     @Model.ShippingAddress.Line1, @Model.ShippingAddress.City
                                    @if (!string.IsNullOrEmpty(Model.ShippingAddress.Province))
                                    {
                                        <span>, @Model.ShippingAddress.Province</span>
                                    }
                                 </p>
                             </div>
                         </div>
                     </div>
                 }
                 else
                 {
                     <p class="text-zinc-500 italic">No shipping info available.</p>
                 }
            </div>
            
            <!-- Actions -->
             <div class="bg-zinc-900 border border-white/10 p-6 print:hidden">
                 <button onclick="window.print()" class="w-full flex items-center justify-center gap-2 border border-white/10 text-zinc-400 hover:text-white hover:bg-white/5 py-3 transition-colors mb-0">
                     <i class="bi bi-printer"></i> PRINT INVOICE
                 </button>
             </div>
        </div>
    </div>
</div>

<!-- Custom Tailwind Modal -->
<div id="cancelOrderModal" class="fixed inset-0 z-[100] hidden" aria-hidden="true">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0 modal-backdrop"></div>
    
    <!-- Modal Content -->
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-zinc-900 border border-white/10 p-8 w-full max-w-md relative z-10 transform scale-95 opacity-0 transition-all modal-content shadow-2xl">
            <h3 class="text-2xl font-display font-bold text-white mb-4">CANCEL ORDER?</h3>
            <p class="text-zinc-400 mb-4">Are you sure you want to cancel order <span class="text-white font-mono">#@Model.Id.ToString("D6")</span>?</p>
            
            <div class="mb-6">
                 <label for="cancelReason" class="block text-xs uppercase text-zinc-500 font-bold mb-2">Reason (Optional)</label>
                 <textarea id="cancelReason" rows="3" class="w-full bg-black/50 border border-white/10 text-white p-3 focus:outline-none focus:border-primary transition-colors text-sm" placeholder="Why are you cancelling?"></textarea>
            </div>

            <div class="flex gap-4">
                <button type="button" class="flex-1 px-6 py-3 border border-white/10 text-white hover:bg-white/5 transition-colors" id="closeModalBtn">
                    KEEP ORDER
                </button>
                <button type="button" class="flex-1 px-6 py-3 bg-red-600 text-white hover:bg-red-700 transition-colors font-bold" id="confirmCancelBtn">
                    YES, CANCEL
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let currentOrderId = @Model.Id;
            const modal = document.getElementById('cancelOrderModal');
            const backdrop = modal.querySelector('.modal-backdrop');
            const content = modal.querySelector('.modal-content');
            
            // Modal Functions
            function showModal() {
                modal.classList.remove('hidden');
                void modal.offsetWidth; // Reflow
                backdrop.classList.remove('opacity-0');
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }

            function hideModal() {
                backdrop.classList.add('opacity-0');
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }

            // Event Listeners
            document.querySelectorAll('.cancel-order-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    showModal();
                });
            });

            document.getElementById('closeModalBtn').addEventListener('click', hideModal);
            backdrop.addEventListener('click', hideModal);

            // AJAX Cancel Logic
            document.getElementById('confirmCancelBtn').addEventListener('click', function() {
                const reason = document.getElementById('cancelReason').value;
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                $.ajax({
                    url: '@Url.Action("CancelOrder", "Order")',
                    type: 'POST',
                    data: {
                        orderId: currentOrderId,
                        reason: reason
                    },
                    headers: { 'RequestVerificationToken': token },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'CANCELLED',
                                text: 'Order cancelled successfully.',
                                background: '#18181b',
                                color: '#ffffff',
                                confirmButtonColor: '#eab308'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'ERROR',
                                text: response.message || 'Error occurred.',
                                background: '#18181b',
                                color: '#ffffff',
                                confirmButtonColor: '#ef4444'
                            });
                        }
                        hideModal();
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'ERROR',
                            text: 'Connection failed.',
                            background: '#18181b',
                            color: '#ffffff',
                            confirmButtonColor: '#ef4444'
                        });
                        hideModal();
                    }
                });
            });
        });
    </script>
}